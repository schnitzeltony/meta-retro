From c40e6aedf69c57269fd63c145436239eee185bcb Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Andreas=20M=C3=BCller?= <schnitzeltony@gmail.com>
Date: Tue, 5 Mar 2019 21:08:38 +0100
Subject: [PATCH 1/2] pokey_device::step_pot: remove operations with no effect
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

* step_pot is called once only. There is ensured already that pokey is in
  reset state.
* in case there were no bits latched to one, there is no need to call
  synchronize(SYNC_POT, 0) because m_ALLPOT won't change.

Performance results with missile / starwars:
Before:
./mame64 -bench 50 missile -> Average speed: 1171.67% (49 seconds)
./mame64 -bench 50 starwars -> Average speed: 551.66% (49 seconds)
After:
./mame64 -bench 50 missile -> Average speed: 1321.16% (49 seconds)
./mame64 -bench 50 starwars -> Average speed: 551.10% (49 seconds)

Upstream-Status: Applied [1]

[1] https://github.com/mamedev/mame/pull/4729

Signed-off-by: Andreas MÃ¼ller <schnitzeltony@gmail.com>
---
 src/devices/sound/pokey.cpp | 9 ++++-----
 1 file changed, 4 insertions(+), 5 deletions(-)

diff --git a/src/devices/sound/pokey.cpp b/src/devices/sound/pokey.cpp
index 231dc01e8b..5aa797bb54 100644
--- a/src/devices/sound/pokey.cpp
+++ b/src/devices/sound/pokey.cpp
@@ -538,11 +538,8 @@ void pokey_device::step_keyboard()
 
 void pokey_device::step_pot()
 {
-	if ((m_SKCTL & SK_RESET) == 0)
-		return;
-
-	uint8_t upd = 0;
 	m_pot_counter++;
+	uint8_t upd = 0;
 	for (int pot = 0; pot < 8; pot++)
 	{
 		if ((m_POTx[pot]<m_pot_counter) || (m_pot_counter == 228))
@@ -551,7 +548,9 @@ void pokey_device::step_pot()
 			/* latching is emulated in read */
 		}
 	}
-	synchronize(SYNC_POT, upd);
+	// some pots latched?
+	if (upd != 0)
+		synchronize(SYNC_POT, upd);
 }
 
 /*
-- 
2.20.1

